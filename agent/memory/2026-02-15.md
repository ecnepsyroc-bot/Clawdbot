# Memory Update — 2026-02-15

## Session Summary

Continued P16 workstation cleanup, then fixed two critical OpenClaw infrastructure issues: auth profile drift and browser relay chicken-and-egg startup bug.

---

## What Changed

### 1. Browser Relay Fix — Eager Startup (runner.ts patch)

**Problem:** The Chrome extension (Browser Relay) showed `!` badge because the local relay server on port 18792 wasn't running. The relay was lazy-started — only initialized when the gateway sent a `browser.proxy` request to the node. But the extension needs the relay running to connect, creating a chicken-and-egg deadlock: extension shows `!` → user can't attach → no browser actions ever sent → relay never starts.

**Root Cause:** In `src/node-host/runner.ts`, `ensureBrowserControlService()` was only called at line 690 inside the `browser.proxy` request handler. Nobody called it during node startup.

**Fix:** Added eager startup call after GatewayClient creation (line 571 in source):

```typescript
// Eagerly start browser control service so the Chrome extension relay
// is ready before the first browser.proxy request (fixes chicken-and-egg
// where extension shows "!" because relay hasn't started yet).
if (browserProxyEnabled) {
  ensureBrowserControlService().catch(() => {});
}
```

**Why it's safe:**
- `ensureBrowserControlService()` is idempotent — caches its promise in `browserControlReady` (line 241-244), returns early if already set
- `ensureChromeExtensionRelayServer()` checks `serversByPort.get(info.port)` and returns existing server
- The lazy call at line 690 still works as a fallback — it just finds the service already started
- Guarded by `browserProxyEnabled` check, same condition used elsewhere

**Architecture chain:**
1. `runner.ts` calls `ensureBrowserControlService()`
2. → `control-service.ts:startBrowserControlServiceFromConfig()` loads config, resolves profiles
3. → For profiles with `driver === "extension"`, calls `ensureChromeExtensionRelayServer({ cdpUrl })`
4. → `extension-relay.ts` starts HTTP+WS server on 127.0.0.1:18792
5. → Chrome extension connects via `/extension` WebSocket

**Config dependency:** `browser.enabled` defaults to `true` (`DEFAULT_CLAWD_BROWSER_ENABLED` in constants.ts). The built-in `chrome` profile with `driver: "extension"` is auto-created by `ensureDefaultChromeExtensionProfile()` in `config.ts:122-139`. No config changes needed.

**Files modified:**
- `src/node-host/runner.ts` — added 4 lines after line 569

**Durability:**
- Watchdog (`node-watchdog.cmd`) runs `dist/index.js` directly → rebuilt code is always used on restart
- No external config dependency — the `chrome` profile is auto-created in code
- Idempotent — safe to call multiple times, safe alongside the lazy fallback

### 2. Auth Profile Fix — OAuth Credential Transplant

**Problem:** All auth profiles were using a stale direct API token instead of the Claude Max OAuth subscription. Direct API token = expensive per-token billing. OAuth through Max = included in subscription.

**Root Cause:** Three profiles existed in `auth-profiles.json`:
- `anthropic:claude-cli` — OAuth type, but tokens expired Jan 29
- `anthropic:manual` — non-refreshable token type (`sk-ant-api03-`)
- `anthropic:dejavara` — non-refreshable token type (`sk-ant-api03-`)
- `lastGood` pointed to `anthropic:manual`, bypassing the refreshable OAuth profile

**Fix:**
1. Transplanted fresh OAuth tokens from Claude CLI (`~/.claude/.credentials.json`) into `anthropic:claude-cli` profile
2. Deleted `anthropic:manual` and `anthropic:dejavara` stale profiles
3. Set `lastGood` to `anthropic:claude-cli`
4. Added `auth.order.anthropic: ["anthropic:claude-cli"]` to `clawdbot.json` to prevent drift

**Token types (reference):**
- `sk-ant-oat01-` = OAuth Access Token (short-lived, auto-refreshed)
- `sk-ant-ort01-` = OAuth Refresh Token (long-lived, used to get new access tokens)
- `sk-ant-api03-` = Direct API key (non-refreshable, pay-per-token)

**Files modified:**
- `~/.openclaw/agents/main/agent/auth-profiles.json` — fresh OAuth, stale profiles removed
- `~/.openclaw/clawdbot.json` — added `auth.order` block

### 3. Workstation Cleanup (continued from 2026-02-14)

**Desktop sweep (Batch 1):**
- Deleted broken path artifacts: `c\`, `C:UserscoryToolsDisplayProfiler\`, `Users\`, `DC\`
- Deleted ghost `C:\Users\cory\Dev\` directory
- Deleted `tmp\` directory
- Deleted junk files: `delete`, `-ErrorAction`, `nul`, `nul.txt`
- Deleted stale `.claude.json.backup.*` and `.corrupted.*` files

**Downloads cleanup (Batch 2):**
- Deleted "Claude Setup (1).exe" and `hexagonal-refactor-prompt.md`

**NuGet cache cleared:** 3.8 GB freed (`dotnet nuget locals all --clear`)

**Deep disk cleanup:**
| Item | Size Freed |
|------|-----------|
| AnythingLLM | 86.8 GB |
| Ollama (.ollama/ models) | 29+ GB |
| .gemini/ | 5.6 GB |
| npm cache | 3.9 GB |
| NuGet cache | 3.8 GB |
| pnpm store | 2.4 GB |
| **Total** | **~130 GB** |

C: drive went from ~350 GB free to 501 GB free.

### 4. Antigravity IDE Fix — Extension Conflicts

**Problem:** Claude Code panel not appearing in Antigravity (VS Code fork, v1.16.5).

**Root Cause:** 7 third-party Claude-related extensions conflicting with the official Anthropic extension. Key culprit: `yuanzhixiang.claude-code-yolo` registered the same filesystem provider (`_claude_vscode_fs_left`), causing panel registration corruption.

**Fix:** Manually deleted 7 conflicting extension directories from `~/.antigravity/extensions/`. Antigravity CLI (`antigravity --uninstall-extension`) crashes with V8 error, so manual deletion was required.

### 5. Workspace and Settings Cleanup

- `Cambium/cambium.code-workspace` — removed dead `Folder Organizer` entry, fixed stale `C:\Dev\cambium\` → `C:\Dev\Dejavara\Cambium\` path
- `Cambium/.claude/settings.local.json` — rewrote from 110 lines of accumulated one-shot permissions to 56 clean wildcard patterns

---

## Current System State

### OpenClaw Infrastructure
- **Node:** Running (PID 44840), connected to gateway at 192.168.1.76:18789
- **Browser Relay:** Port 18792 LISTENING, Chrome extension connected (ESTABLISHED connections visible)
- **Auth:** Using `anthropic:claude-cli` OAuth profile → Claude Max subscription (no per-token charges)
- **Watchdog:** `node-watchdog.cmd` auto-restarts node, uses `dist/index.js` directly

### Development Environment
- **C: drive:** 501 GB free (was ~350 GB before cleanup)
- **Antigravity IDE:** Working, Claude Code panel functional after extension cleanup
- **Cambium:** Root.sln builds clean (0 errors, 47 warnings)

### Things Still Pending
- `C:\OneDriveTemp\` still locked by OneDrive — needs reboot or OneDrive stop to delete
- New scripts in `C:\Dev\Dejavara\scripts\` haven't been committed to git yet
- Runner.ts patch should be committed to OpenClaw
